#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# Check for staged TS/TSX files to optimize validation time
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep "\.tsx\?$" || true)

# Skip if no TypeScript files are staged
if [ -z "$STAGED_TS_FILES" ]; then
  echo "âœ… No TypeScript files to validate"
  exit 0
fi

# Format files
echo "ğŸ¨ Formatting code..."
npx prettier --write $STAGED_TS_FILES
git add $STAGED_TS_FILES

# Run TypeScript checks
echo "ğŸ“ Running TypeScript checks..."
npx tsc --noEmit

# Run ESLint
echo "ğŸ§¹ Running ESLint..."
npx eslint $STAGED_TS_FILES --fix
git add $STAGED_TS_FILES

# Run tests related to staged files
echo "ğŸ§ª Running tests..."
npx jest --bail --findRelatedTests $STAGED_TS_FILES

echo "âœ… Pre-commit checks passed! Committing now..."